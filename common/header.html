<script type='text/x-handlebars' data-template-name='discovery/categories'>
  {{#discovery-categories refresh=(action "refresh")}}
    {{component 'categories-and-latest-topics' model=model}}
  {{/discovery-categories}}
</script>

<script type='text/x-handlebars' data-template-name='mobile/discovery/categories'>
  {{#discovery-categories refresh=(action "refresh")}}
    {{component 'categories-and-latest-topics' model=model}}
  {{/discovery-categories}}
</script>

<script type='text/x-handlebars' data-template-name='components/categories-and-latest-topics'>
  <div class='column categories'>
    <section class="landing">
      <div class="first">
        <div class="home-image"></div>
        <div class="site-title">
          Hey, we're Pavilion.
        </div>
        <div class="home-title">
          We <a href="#links" class="animated-link">work with online communities</a>,
          <a href="#plugins" class="animated-link">support open-source</a> and
          <a href="#teach" class="animated-link">mentor apsiring developers</a>.
        </div>
      </div>

      <div class="home-actions">
        <ul class="links">
          <li>
            <a href="http://discourse.angusmcleod.com.au/new-message?groupname=team&title=Consulting%20Enquiry">
              <img class="image start" src="{{imageUrls.balloons}}">
              <span class="label">Hire us to work on your community</span>
            </a>
          </li>
          <li>
            <a href="#plugins">
              <img class="image plugins" src="{{imageUrls.bike}}">
              <span class="label">Check out our open source work</span>
            </a>
          </li>
          <li>
            <a href="#learn">
              <img class="image learn" src="{{imageUrls.guitar}}">
              <span class="label">Learn about our mentoring</span>
            </a>
          </li>
        </ul>
      </div>

      <div class="landing-block">
        <div class="home-title">
          <a name="team" href="#team">Our Team</a>
        </div>
        <div class="home-profiles">
          {{#each model.teamMembers as |tm|}}
            <div class="home-profile">
              <div class="avatar">
                {{avatar tm avatarTemplatePath="avatar_template"
                            usernamePath="username"
                            namePath="name"
                            imageSize="huge"}}
              </div>
              <div class="details">
                <div class="name">
                  {{tm.name}}
                </div>
                <div class="bio">
                  {{tm.bio}}
                </div>
              </div>
            </div>
          {{/each}}
        </div>
      </div>

      <div class="landing-block">
        <div class="home-title">
          <a name="agenda" href="#agenda">Our Agenda</a>
        </div>
        {{basic-topic-list topics=model.workTopics}}
      </div>
    </section>

    {{!--<div class='column'>
      {{categories-topic-list topics=model.topics filter="latest" class="latest-topic-list"}}
    </div>--}}
  </div>
</script>

<script type="text/discourse-plugin" version="0.8">
  const computed = require('ember-addons/ember-computed-decorators').default;
  const container = Discourse.__container__;
  const store = container.lookup("service:store");
  const { ajax } = require('discourse/lib/ajax');
  const nonPluginCategories = ['public-work', 'introductions', 'meta', 'knowledge-base', 'news'];
  const workCategory = 'public-work/tasks';

  api.modifyClass('component:categories-and-latest-topics', {
    @computed('model.categories')
    filteredCategories(categories) {
      return categories.filter(c => {
        return !c.read_restricted && nonPluginCategories.indexOf(c.slug) === -1;
      });
    },

    @computed()
    imageUrls(){
      let style = null;
      if (window.getComputedStyle && window.getComputedStyle(document.body, '::before')) {
        style = window.getComputedStyle(document.body, '::before');
        style = style.content;
      }
      return JSON.parse(JSON.parse(style));
    }
  });

  api.modifyClass('route:discovery-categories', {
    afterModel(model, transition) {
      return Ember.RSVP.all([
        this.store.findFiltered("topicList", {
          filter: `c/${workCategory}`
        }).then(result => {
          model.set('workTopics', result.topics);
        }),
        ajax(`/groups/team/members.json`).then(result => {
          console.log(result);
          model.set('teamMembers', result.members)
        })
      ]);
    }
  });
</script>
