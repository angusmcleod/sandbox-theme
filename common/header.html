<script type='text/x-handlebars' data-template-name='discovery/categories'>
  {{#discovery-categories refresh=(action "refresh")}}
    {{component 'categories-and-latest-topics' model=model}}
  {{/discovery-categories}}
</script>

<script type='text/x-handlebars' data-template-name='components/categories-and-latest-topics'>
  <div class='column categories'>
    <section class="landing">
      <div class="first">
        <div class="home-image"></div>
        <div class="site-title">
          Hey, we're Pavilion.
        </div>
        <div class="home-title">
          We <a href="#links">build online communities</a>,
          <a href="#plugins">support open-source</a> and
          <a href="#teach">teach people how to code</a>
        </div>
      </div>

      <div class="home-title">
        <a name="links" href="#links">How can we help?</a>
      </div>

      <div class="home-actions">
        <ul class="links">
          <li>
            <a href="http://discourse.angusmcleod.com.au/new-message?groupname=team&title=I%20want%20to%20start%20an%20online%20community">
              <div class="image start"></div>
              <span>I want to start a community</span>
            </a>
          </li>
          <li>
            <a href="http://discourse.angusmcleod.com.au/new-message?groupname=team&title=I%20want%20to%20improve%20my%20community">
              <div class="image improve"></div>
              <span>I want to improve my community</span>
            </a>
          </li>
          <li>
            <a href="#plugins">
              <div class="image plugins"></div>
              <span>I want to use your open source work</span>
            </a>
          </li>
          <li>
            <a href="#learn">
              <div class="image learn"></div>
              <span>I want to learn how to code</span>
            </a>
          </li>
        </ul>
      </div>

      <div class="landing-block">
        <a name="clients"></a>
        <div class="home-title">Our Clients</div>
      </div>

      <div class="landing-block">
        <a name="team"></a>
        <div class="home-title">Our Team</div>
      </div>

      <div class="landing-block">
        <a name="plugins"></a>
        <div class="home-title">Our Projects</div>
        {{#each filteredCategories as |c|}}
          {{category-link c}}
        {{/each}}
      </div>

      <div class="landing-block">
        <label>Our Agenda</label>
        {{basic-topic-list topics=model.workTopics}}
      </div>
    </section>

    {{!--<div class='column'>
      {{categories-topic-list topics=model.topics filter="latest" class="latest-topic-list"}}
    </div>--}}
  </div>
</script>

<script type="text/discourse-plugin" version="0.8">
  const computed = require('ember-addons/ember-computed-decorators').default;
  const container = Discourse.__container__;
  const store = container.lookup("service:store");
  const nonPluginCategories = ['public-work', 'introductions', 'meta', 'knowledge-base', 'news'];

  api.modifyClass('component:categories-and-latest-topics', {
    @computed('model.categories')
    filteredCategories(categories) {
      return categories.filter(c => {
        return !c.read_restricted && nonPluginCategories.indexOf(c.slug) === -1;
      });
    }
  });

  api.modifyClass('route:discovery-categories', {
    afterModel(model, transition) {
      return this.store.findFiltered("topicList", {
        filter: `c/public-work`
      }).then(result => {
        model.set('workTopics', result.topics);
      });
    }
  });
</script>
